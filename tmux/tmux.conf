# Reload tmux.conf
unbind r
bind r source-file ~/.tmux.conf

# Prefix and shell
set -g default-shell /bin/zsh
set -g default-command "exec /bin/zsh"
unbind C-b
set -g prefix C-a
bind C-a send-prefix
set -g repeat-time 0
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on

# Status bar at top
set-option -g status-position top

# Clipboard, mouse, and focus
set -g set-clipboard on
set -g mouse on
set -g focus-events on
setw -g mode-keys vi
set -g status-keys vi

# History and responsiveness
set -g history-limit 10000
set -sg escape-time 0
set -g status-interval 1

# Terminal capabilities (truecolor + undercurl)
set -g default-terminal "tmux-256color"
set -as terminal-overrides ",xterm-256color:Tc"
set -as terminal-overrides ",screen-256color:Tc"
set -as terminal-overrides ",*:Smulx=\E[4::%p1%dm,Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%"

# Splits and windows in current directory
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Smart pane switching with Vim awareness
# Uses ps to detect if current pane is running vim/nvim, then either
# sends the key to vim (for split navigation) or switches tmux panes
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Copy-mode navigation (no vim detection needed)
bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# Pane resize
bind -n M-Left resize-pane -L 5
bind -n M-Right resize-pane -R 5
bind -n M-Up resize-pane -U 2
bind -n M-Down resize-pane -D 2

# Utilities
bind C-k clear-history
bind-key R switch-client -r

# Activity
set -g monitor-activity on
set -g visual-activity on

# Plugins (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'catppuccin/tmux'

# Catppuccin configuration
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Status bar - directory + session name for context
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_directory}"
set -ag status-right "#{E:@catppuccin_status_session}"

# tmux-sessionizer keybind (passes current pane path)
bind-key -r f run-shell "tmux neww ~/.local/bin/tmux-sessionizer '#{pane_current_path}'"

# Session persistence
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
